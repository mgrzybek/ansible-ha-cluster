# Copyright (C) 2016 Mathieu Grzybek
#
# License: GNU General Public License (GPL)
---
- version: 2.2
  category: Cluster
  shortdesc: Deploy management resources.
  longdesc: |
    Deploy a floating IP and Hawk.
    A management resource group is created.
    Location is set by 'attribute_name' and 'attribute_value'.

  parameters:
   - name: ipaddr
     shortdesc: Adresse IP
     longdesc: Adresse de management
     required: true
     type: string

   - name: attribute_name
     shortdesc: Attribute to check for placement.
     longdesc: Attribute to check for placement.
     required: true
     type: string

   - name: attribute_value
     shortdesc: Value to test.
     longdesc: Value to test.
     required: true
     type: string

  actions:
    - cib: |
        primitive mgmt_ip_addr IPaddr2
          params ip={{ipaddr}}
          op monitor interval=10 timeout=20
          op start timeout=20 interval=0
          op stop timeout=20 interval=0

    - cib: |
        primitive hawk systemd:hawk

    - cib: |
        group mgmt_rg hawk mgmt_ip_addr

    - cib: |
        location loc_mgmt_rg mgmt_rg resource-discovery=always
          rule -inf: {{attribute_name}} ne {{attribute_value}}
